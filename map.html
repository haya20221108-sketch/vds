<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>H1E è¬è§£ã - æ ¡å†…ãƒãƒƒãƒ—</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <aside id="sidebar">
      <button id="toggle-sidebar">ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹</button>
      <div id="status-content">
        <h2>ğŸ† é”æˆçŠ¶æ³</h2>
        <ul id="achievement-list"></ul>
        <p id="quiz-count">ã‚¯ãƒªã‚¢æ•°: 0 / 3</p>
      </div>
    </aside>
    <header>
      <button id="menu-button">
        <span class="hamburger-icon"></span>
        <span class="hamburger-icon"></span>
        <span class="hamburger-icon"></span>
      </button>
      <p id="user-info">ã‚ˆã†ã“ãã€[ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ]ã•ã‚“ï¼</p>
    </header>

    <main>
      <h1>è¬ã®ç›®æ¨™åœ°ç‚¹</h1>

      <div id="map-container">
        <div id="map">
          <div id="map-overlay"></div>
          <img id="custom-map-image" src="S__3383319.jpg" alt="å­¦æ ¡ãƒãƒƒãƒ—" />
        </div>
        <p id="location-status">ä½ç½®æƒ…å ±ã‚’å–å¾—ä¸­...</p>
      </div>

      <div id="quiz-entry-container" class="hidden">
        <h2 id="quiz-name">è¬ã®å ´æ‰€ã§ã™ï¼</h2>
        <button id="start-quiz-button">è¬è§£ããƒšãƒ¼ã‚¸ã¸é€²ã‚€</button>
      </div>
    </main>

    <script src="common.js"></script>
    <script>
      // è¬ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå®šç¾©
      const QUIZ_TARGETS = [
        {
          id: "è¬1",
          name: "è¬1: å›³æ›¸é¤¨ä»˜è¿‘ (3F)",
          img_y: 20,
          img_x: 25,
          lat: 35.7564606,
          lon: 139.6792595,
          page: "quiz_page_1.html",
        },
        {
          id: "è¬2",
          name: "è¬2: è·å“¡å®¤ä»˜è¿‘ (3F)",
          img_y: 20,
          img_x: 71,
          lat: 35.75665,
          lon: 139.6786892,
          page: "quiz_page_2.html",
        },
        {
          id: "è¬3",
          name: "è¬3: 2F M2Aä»˜è¿‘",
          img_y: 65,
          img_x: 30,
          lat: 35.7562824,
          lon: 139.6797222,
          page: "quiz_page_3.html",
        },
      ];

      const PROXIMITY_THRESHOLD_M = 20;
      let currentAchievement = [];
      let watchId;

      function drawQuizPins() {
        const overlay = document.getElementById("map-overlay");
        overlay.innerHTML = "";
        currentAchievement = localStorage.getItem("h1e_achievements")
          ? JSON.parse(localStorage.getItem("h1e_achievements"))
          : [];
        QUIZ_TARGETS.forEach((quiz) => {
          if (!currentAchievement.includes(quiz.id)) {
            const pin = document.createElement("div");
            pin.className = "quiz-pin";
            pin.title = quiz.name;
            pin.style.top = `${quiz.img_y}%`;
            pin.style.left = `${quiz.img_x}%`;
            pin.setAttribute("data-quiz-id", quiz.id);
            overlay.appendChild(pin);
          }
        });
        if (typeof loadAchievements === "function") {
          loadAchievements();
        }
      }

      function startLocationWatch() {
        const statusElement = document.getElementById("location-status");
        if (!navigator.geolocation) {
          statusElement.textContent = "ã‚¨ãƒ©ãƒ¼: ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚";
          return;
        }
        const options = {
          enableHighAccuracy: true,
          timeout: 5000,
          maximumAge: 0,
        };
        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            statusElement.textContent = `ç¾åœ¨åœ°: ç·¯åº¦ ${lat.toFixed(
              6
            )}, çµŒåº¦ ${lon.toFixed(
              6
            )} (ç²¾åº¦: ${position.coords.accuracy.toFixed(1)}m)`;
            checkProximity(lat, lon);
          },
          (error) => {
            statusElement.textContent = `ã‚¨ãƒ©ãƒ¼: ä½ç½®æƒ…å ±å–å¾—ã«å¤±æ•— (${error.code})ã€‚`;
            console.error("Geolocation Error:", error.message);
          },
          options
        );
      }

      function checkProximity(userLat, userLon) {
        let isNearAnyQuiz = false;
        let targetQuiz = null;
        const unClearedQuizzes = QUIZ_TARGETS.filter(
          (q) => !currentAchievement.includes(q.id)
        );
        for (const quiz of unClearedQuizzes) {
          const distance = calculateDistance(
            userLat,
            userLon,
            quiz.lat,
            quiz.lon
          );
          if (distance <= PROXIMITY_THRESHOLD_M) {
            isNearAnyQuiz = true;
            targetQuiz = quiz;
            break;
          }
        }
        const container = document.getElementById("quiz-entry-container");
        const quizNameElement = document.getElementById("quiz-name");
        const startButton = document.getElementById("start-quiz-button");
        if (isNearAnyQuiz && targetQuiz) {
          container.classList.remove("hidden");
          quizNameElement.textContent = `${targetQuiz.name} ã«è¿‘ã¥ãã¾ã—ãŸï¼`;
          document
            .querySelectorAll(".quiz-pin")
            .forEach((p) => p.classList.remove("blinking"));
          const pinElement = document.querySelector(
            `.quiz-pin[data-quiz-id="${targetQuiz.id}"]`
          );
          if (pinElement) pinElement.classList.add("blinking");
          startButton.onclick = () => {
            window.location.href = targetQuiz.page;
          };
        } else {
          container.classList.add("hidden");
          document
            .querySelectorAll(".quiz-pin")
            .forEach((p) => p.classList.remove("blinking"));
        }
      }

      function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const Ï†1 = (lat1 * Math.PI) / 180;
        const Ï†2 = (lat2 * Math.PI) / 180;
        const Î”Ï† = ((lat2 - lat1) * Math.PI) / 180;
        const Î”Î» = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
          Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c;
      }

      // ğŸš¨ ä¿®æ­£ç‚¹3: DOMContentLoadedã§å…¨ã¦ã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œ ğŸš¨
      document.addEventListener("DOMContentLoaded", () => {
        let nickname = sessionStorage.getItem("currentNickname");
        if (!nickname) {
          alert("ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒç¢ºèªã§ãã¾ã›ã‚“ã€‚ç™»éŒ²ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚");
          window.location.href = "index.html";
          return;
        }
        document.getElementById(
          "user-info"
        ).textContent = `ã‚ˆã†ã“ãã€${nickname}ã•ã‚“ï¼`;

        // ãƒ”ãƒ³ã®æç”»ã¨GPSç›£è¦–ã‚’é–‹å§‹
        drawQuizPins();
        startLocationWatch();
      });
    </script>
  </body>
</html>
